<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doodle Bash</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Covered+By+Your+Grace&family=Fira+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    #game-container {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 56.25dvh;
      height: 100dvh;
      display: grid;
      grid-template-rows: 1fr 3fr 1fr;
      overflow: hidden;
      container-type: inline-size;
    }

    @media (max-aspect-ratio: 9/16) {
      #game-container {
        width: 100vw;
        height: calc(100vw * 16 / 9);
      }
    }

    #header,
    #footer {
      container-type: inline-size;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      gap: 4cqi;
    }

    #shuffle-zone {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(5, 1fr);
      height: 100%;
      width: 100%;
      container-type: inline-size;
      overflow: hidden;
    }

    #doodle-l1 {
      grid-column: 1;
      grid-row: 2;
    }

    #doodle-l2 {
      grid-column: 1;
      grid-row: 3;
    }

    #doodle-l3 {
      grid-column: 1;
      grid-row: 4;
    }

    #doodle-r1 {
      grid-column: 3;
      grid-row: 2;
    }

    #doodle-r2 {
      grid-column: 3;
      grid-row: 3;
    }

    #doodle-r3 {
      grid-column: 3;
      grid-row: 4;
    }

    #doodle-l1,
    #doodle-l2,
    #doodle-l3,
    #doodle-r1,
    #doodle-r2,
    #doodle-r3 {
      background-size: auto 75%;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 20;
      transition: transform 0.35s ease-out;
      transform: translateY(100dvh) rotate(0deg);
      cursor: pointer;
    }

    button {
      border: none;
      font-family: 'Covered By Your Grace', cursive;
      font-weight: 400;
      cursor: pointer;
      transition: transform 0.2s;
    }

    button:hover {
      transform: scale(1.05);
    }

    #header button,
    #footer button {
      font-size: 6.5cqi;
      padding: 3cqi 9cqi;
      border-radius: 9999px;
    }

    #header button {
      background: #7f2a8f;
      color: white;
    }

    #footer button {
      background: #fbb065;
      color: #000;
    }

    #shuffle-btn {
      grid-column: 2;
      grid-row: 3;
      background: #4dbde5;
      color: white;
      font-size: 6.5cqi;
      width: 100%;
      border-radius: 9999px;
    }

    /* MODALS */
    .modal {
      position: absolute;
      inset: 0;
      background: #fff;
      display: none;
      flex-direction: column;
      z-index: 100;
      container-type: inline-size;
      transform: translateY(0);
      transition: transform 0.4s ease-out;
    }

    .modal.learn {
      transform: translateY(-100%);
    }

    .modal.portfolio {
      transform: translateY(100%);
    }

    .modal.guide {
      transform: translateX(-100%);
    }

    .modal.active {
      display: flex;
      transform: translate(0);
    }

    .modal-top {
      flex: 0 0 18%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 4cqi;
      color: white;
    }

    .modal-top.learn {
      background: #7f2a8f;
    }

    .modal-top.portfolio {
      background: #fbb065;
      color: #000;
    }

    .modal-top.guide {
      background: #4dbde5;
    }

    .modal-top .title {
      font-family: 'Fira Sans', sans-serif;
      font-weight: 600;
      font-size: 5cqi;
    }

    .modal-top .buttons {
      display: flex;
      align-items: center;
      gap: 10.5cqi;
    }

    .close-btn,
    .action-btn {
      height: 9cqi;
      line-height: 9cqi;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 7cqi;
    }

    .close-btn {
      width: 9cqi;
      border-radius: 2cqi;
      background: rgba(255, 255, 255, 0.25);
      color: white;
    }

    .modal-top.portfolio .close-btn,
    .modal-top.guide .close-btn {
      background: rgba(0, 0, 0, 0.15);
      color: #000;
    }

    .action-btn {
      padding: 0 6cqi;
      font-size: 6cqi;
      min-width: 14cqi;
      border-radius: 9999px;
      display: none;
    }

    .action-btn.learn {
      background: #fbb065;
      color: #000000;
    }

    .action-btn.remove {
      background: #7f2a8f;
      color: white;
    }

    .modal-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(7, 1fr);
      gap: 1.4cqi;
      padding: 1.8cqi;
      overflow: hidden;
    }

    .modal-bottom-spacer {
      flex: 0 0 2.25%;
      background: transparent;
    }

    .doodle-cell {
      min-height: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1cqi;
      border-radius: 18px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .doodle-cell:hover:not(.selected) {
      background: rgba(255, 255, 255, 0.4);
      transform: scale(1.1);
    }

    .doodle-cell.selected {
      transform: scale(1.5);
      z-index: 10;
      opacity: 1 !important;
    }

    .modal-grid .doodle-cell:not(.selected) {
      opacity: 0.5;
    }

    .modal-grid:not(:has(.selected)) .doodle-cell {
      opacity: 1;
    }

    .doodle-img {
      width: 92%;
      aspect-ratio: 1 / 1;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 14px;
      transition: all 0.6s ease-out;
    }

    .doodle-cell.animate-learn .doodle-img {
      animation: learnSpinShrink 0.6s ease-in-out forwards;
    }

    @keyframes learnSpinShrink {
      0% {
        transform: scale(1) rotate(0deg);
      }

      40% {
        transform: scale(0.1) rotate(720deg);
      }

      100% {
        transform: scale(1) rotate(720deg);
      }
    }

    .doodle-cell.animate-remove {
      animation: removeSlideDown 0.6s ease-in-out forwards;
    }

    @keyframes removeSlideDown {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(200%);
      }
    }

    .doodle-cell.animate-remove .doodle-img {
      animation: spinFadeScale 0.6s ease-in-out forwards;
    }

    @keyframes spinFadeScale {
      0% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: scale(0.1) rotate(720deg);
        opacity: 0;
      }
    }

    /* GUIDE MODAL */
    #guide-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 3cqi 4cqi;
      display: flex;
      flex-direction: column;
      gap: 1.2cqi;
    }

    .merge-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      /* border-bottom removed — let group dividers do the work */
    }

    .inputs {
      display: flex;
      gap: 1.6cqi;
      flex-shrink: 0;
    }

    .arrow-container {
      flex: 1;
      display: flex;
      align-items: center;
      height: 10cqi;
      margin: 0 4cqi;
    }

    .arrow-line {
      flex: 1;
      height: 0.5cqi;
      background: #222;
      border-radius: 2px;
      position: relative;
    }

    .arrow-line::after {
      content: '';
      position: absolute;
      right: 1.1cqi;
      top: 50%;
      transform: translateY(-50%) rotate(45deg);
      width: 5.2cqi;
      height: 5.2cqi;
      border-top: 0.5cqi solid #222;
      border-right: 0.5cqi solid #222;
      border-bottom: none;
      border-left: none;
    }

    .result {
      flex-shrink: 0;
    }

    .guide-doodle {
      width: 8.7cqi;
      height: auto;
    }

    /* TOOLTIP */
    #tooltip {
      position: absolute;
      background: #ccecf8;
      border-radius: 2cqi;
      padding: 2cqi 2cqi;
      max-width: 90cqw;
      font-family: 'Fira Sans', sans-serif;
      font-size: 4.2cqi;
      line-height: 1.5;
      z-index: 250;
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: all 0.25s cubic-bezier(0.23, 1, 0.32, 1);
      pointer-events: none;
    }

    #tooltip.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    #tooltip .tooltip-desc {
      color: #222;
    }

    .inline-doodle {
      display: inline-block;
      width: 1.3em;
      height: auto;
      vertical-align: middle;
      margin: 0 0.15em -0.2em;
      background: none;
      box-shadow: none;
      border: none;
      padding: 0;
    }

    /* TOAST */
    #toast {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(251, 176, 101, 0.95);
      color: #000;
      font-family: 'Fira Sans', sans-serif;
      font-weight: 600;
      font-size: 5cqi;
      padding: 2cqi 5cqi;
      border-radius: 9999px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 300;
      white-space: nowrap;
      max-width: 80cqi;
      text-align: center;
    }

    #toast.show {
      opacity: 1;
    }

    .group-divider {
  min-height: .6cqi;
  background: #dbdbdb;
  margin: 2.5cqi 0;
  border-radius: 0.125rem;
  width: 100%;
  flex-shrink: 0;  /* Prevents flex from compressing it */
  align-self: stretch;  /* Ensures it spans the full container width */
}

/* GUIDE FILTERING */
.modal-top.guide .action-btn {
  background: #ffffff;
  color: #5fbae9;
  border: none;  /* Flush like LEARN/REMOVE – no outline */
}

.guide-doodle {
  cursor: pointer;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.guide-doodle:hover,
.guide-doodle.selected {
  transform: scale(1.25);
  box-shadow: 0 0 0 0.5cqi #4dbde5;
  z-index: 10;
}

#guide-content.filtered .group-divider {
  display: none;
}

/* GUIDE HIGHLIGHTING – ROCKING ANIMATION */
.guide-doodle {
  cursor: pointer;
  box-shadow: none !important;   /* Permanent blue outline killer */
  border: none !important;
  /* No transitions here – avoids clashing with animation */
}

.guide-doodle:hover {
  transform: scale(1.1);
  transition: transform 0.25s ease;  /* Isolated to hover only */
}

.guide-doodle.selected {
    transform-origin: center;      /* Pivots from image center */
  animation: rock 1s ease-in-out infinite;
  rotate: 0deg;
}

@keyframes rock {
  0%, 100% {
    transform: scale(1.1);
    rotate:5deg;
  }
  50% {
    transform: scale(1.1);
    rotate:-5deg;
  }
  100% {
    transform: scale(1.1);
    rotate:5deg;
  }
}
  </style>
</head>

<body>

  <div id="game-container">
    <div id="header">
      <button id="guide-btn">GUIDE</button>
      <button id="learn-btn">LEARN</button>
    </div>

    <div id="shuffle-zone">
      <div id="doodle-l1"></div>
      <div id="doodle-l2"></div>
      <div id="doodle-l3"></div>
      <div id="doodle-r1"></div>
      <div id="doodle-r2"></div>
      <div id="doodle-r3"></div>
      <button id="shuffle-btn">SHUFFLE</button>
    </div>

    <div id="footer">
      <button id="portfolio-btn">PORTFOLIO</button>
    </div>

    <!-- LEARN MODAL -->
    <div id="learn-modal" class="modal learn">
      <div class="modal-top learn">
        <div class="title">Learn a Doodle</div>
        <div class="buttons">
          <button class="action-btn learn" id="modal-learn-btn">LEARN</button>
          <button class="close-btn" id="close-learn">✕</button>
        </div>
      </div>
      <div id="learn-grid" class="modal-grid"></div>
      <div class="modal-bottom-spacer"></div>
    </div>

    <!-- PORTFOLIO MODAL -->
    <div id="portfolio-modal" class="modal portfolio">
      <div class="modal-top portfolio">
        <div class="title">Portfolio</div>
        <div class="buttons">
          <button class="action-btn remove" id="modal-remove-btn">REMOVE</button>
          <button class="close-btn" id="close-portfolio">✕</button>
        </div>
      </div>
      <div id="portfolio-grid" class="modal-grid"></div>
      <div class="modal-bottom-spacer"></div>
    </div>

    <!-- GUIDE MODAL -->
    <div id="guide-modal" class="modal guide">
      <div class="modal-top guide">
        <div class="title">Doodle Guide</div>
        <div class="buttons">
          <button class="action-btn" id="full-guide-btn" style="display:none;">FULL GUIDE</button>
          <button class="close-btn" id="close-guide">✕</button>
        </div>
      </div>
      <div id="guide-content"></div>
      <div class="modal-bottom-spacer"></div>
    </div>

    <!-- TOOLTIP -->
    <div id="tooltip">
      <div class="tooltip-desc" id="tooltip-desc"></div>
    </div>

    <!-- TOAST -->
    <div id="toast"></div>
  </div>

  <script>
    let deck = {
      circle: 2,
      square: 2,
      triangle: 2,
      dot: 2,
      line: 2
    };

    const allPossibleDoodles = [
      "circle", "square", "triangle", "line", "dot",
      "lens", "halfcircle", "drop", "teeth", "cylinder",
      "cube", "pyramid", "cloud", "coin", "smiley",
      "letter", "house", "die", "piano", "pizza",
      "star", "wireless", "music", "planet", "sword",
      "fish", "umbrella", "boat", "butterfly", "heart",
      "turd", "flower", "crown", "cat", "rocket",
      "mug", "toiletpaper", "chest", "present", "diamond",
      "icecream"
    ];

    const doodleDescriptions = {
      circle: "{circle} is a basic shape that can merge to create many doodles (see Doodle Guide).",
      square: "{square} is a basic shape that can merge to create many doodles (see Doodle Guide).",
      triangle: "{triangle} is a basic shape that can merge to create many doodles (see Doodle Guide).",
      dot: "{dot} is a basic shape that can merge to create many doodles (see Doodle Guide).",
      line: "{line} is a basic shape that can merge to create many doodles (see Doodle Guide).",
      drop: "{drop} is an intermediate shape that can merge to create {heart}, {flower}, and {turd}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {mug}, {umbrella}, and {cloud}.",
      teeth: "{teeth} is an intermediate shape that can merge to create {cat}, {rocket}, and {crown}.",
      lens: "{lens} is an intermediate shape that can merge to create {rocket}, {planet}, and {fish}.",
      halfcircle: "{halfcircle} is an intermediate shape that can merge to create {chest}, {butterfly}, and {umbrella}.",
      boat: "{boat} scores {2pt} per {fish} <i><b>below</b></i> on <i><b>same page</b></i>.",
      butterfly: "{butterfly} scores {1pt} per {flower} in largest <i><b>group</b></i>.",
      cat: "{cat} scores {3pt} (+{2pt} per <i><b>surrounding</b></i> {fish}/{turd})",
      chest: "{chest} scores {2pt} per <i><b>surrounding</b></i> {coin}/{diamond}/{crown}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {chest}.",
      cloud: "{cloud} scores {1pt} per {drop} <i><b>below</b></i> on <i><b>same page</b></i>.",
      coin: "{coin} scores {2pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {chest}.",
      crown: "{crown} scores {3pt} (+{4pt} if {smiley} is <i><b>directly-below</b></i>).<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {chest}.",
      cube: "{cube} is an intermediate shape that can merge to create {chest} or {present}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Also score {10pt} per set of {cube}{cylinder}{pyramid}.",
      cylinder: "{cylinder} is an intermediate shape that can merge to create {mug} or {toiletpaper}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Also score {10pt} per set of {cube}{cylinder}{pyramid}.",
      diamond: "{diamond} scores {4pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {chest}.",
      die: "{die} copies the value of a <i><b>surrounding</b></i> doodle.",
      flower: "{flower} scores {2pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {butterfly}.",
      heart: "{heart} scores {2pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {letter}.",
      house: "{house} scores {1pt} (+{1pt} per <i><b>surrounding</b></i> {smiley}/{wireless}).",
      icecream: "{icecream} scores {4pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {smiley}.",
      letter: "{letter} scores {1pt} (+{5pt} if {heart} is <i><b>directly-above</b></i>).",
      mug: "{mug} scores {2pt} (+{2pt} if {drop} is <i><b>directly-above</b></i>).",
      music: "{music} scores {1pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {piano}.",
      piano: "{piano} scores {1pt} per <i><b>column</b></i> with {music} on <i><b>any page</b></i>.",
      pizza: "{pizza} scores {3pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {smiley}.",
      planet: "{planet} scores {1pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {rocket}.",
      present: "{present} scores {6pt}.",
      pyramid: "{pyramid} is an intermediate shape that can merge to create {diamond} or {icecream}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Also score {10pt} per set of {cube}{cylinder}{pyramid}.",
      rocket: "{rocket} scores {3pt} per {planet}/{star}.",
      smiley: "{smiley} scores {1pt} (+{1pt} per <i><b>surrounding</b></i> {pizza}/{icecream}).<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {house}.",
      star: "{star} scores {2pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {rocket}.",
      sword: "{sword} scores {5pt}.",
      toiletpaper: "{toiletpaper} scores {1pt} (+{1pt} per <i><b>surrounding</b></i> {turd}).",
      turd: "{turd} scores {minus2pt}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {turd}.",
      umbrella: "{umbrella} scores {1pt} per {drop} <i><b>above</b></i> on the <i><b>same page</b></i>",
      wireless: "{wireless} is used to merge non-adjacent doodles. Circle a {wireless} to use it, then individually circle any doodles you'd like to merge.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {house}.",
      fish: "{fish} scores {1pt} per <i><b>surrounding</b></i> {fish}.<br><hr style='border:0; height:1px; background:#a0d0e8; margin:8px 0;'>Contributes to scoring for {boat}."
    };

    const doodleMerges = [
      { inputs: ["circle", "square"], output: "cylinder" },
      { inputs: ["circle", "circle"], output: "lens" },
      { inputs: ["circle", "line"], output: "halfcircle" },
      { inputs: ["circle", "circle", "line"], output: "cloud" },
      { inputs: ["circle", "line", "line"], output: "coin" },
      { inputs: ["circle", "line", "dot", "dot"], output: "smiley" },
      { inputs: ["square", "square"], output: "cube" },
      { inputs: ["square", "line"], output: "letter" },
      { inputs: ["square", "triangle", "dot"], output: "house" },
      { inputs: ["square", "dot", "dot"], output: "die" },
      { inputs: ["square", "square", "line", "line"], output: "piano" },
      { inputs: ["triangle", "square"], output: "pyramid" },
      { inputs: ["triangle", "circle"], output: "drop" },
      { inputs: ["triangle", "triangle"], output: "teeth" },
      { inputs: ["triangle", "line", "dot", "dot"], output: "pizza" },
      { inputs: ["line", "line", "line"], output: "star" },
      { inputs: ["dot", "line", "line"], output: "wireless" },
      { inputs: ["dot", "dot", "line"], output: "music" },
      { inputs: ["lens", "circle"], output: "planet" },
      { inputs: ["lens", "dot", "line"], output: "sword" },
      { inputs: ["lens", "triangle", "dot"], output: "fish" },
      { inputs: ["halfcircle", "line"], output: "umbrella" },
      { inputs: ["halfcircle", "line", "triangle"], output: "boat" },
      { inputs: ["halfcircle", "halfcircle", "line"], output: "butterfly" },
      { inputs: ["drop", "drop"], output: "heart" },
      { inputs: ["drop", "circle"], output: "turd" },
      { inputs: ["drop", "drop", "dot"], output: "flower" },
      { inputs: ["teeth", "triangle", "dot"], output: "crown" },
      { inputs: ["teeth", "smiley", "line"], output: "cat" },
      { inputs: ["teeth", "lens", "dot", "line"], output: "rocket" },
      { inputs: ["cylinder", "line"], output: "mug" },
      { inputs: ["cylinder", "square", "dot"], output: "toiletpaper" },
      { inputs: ["cube", "halfcircle", "dot"], output: "chest" },
      { inputs: ["cube", "line", "heart"], output: "present" },
      { inputs: ["pyramid", "line", "line"], output: "diamond" },
      { inputs: ["pyramid", "line", "cloud"], output: "icecream" }
    ];

    function formatName(name) {
      return name.charAt(0).toUpperCase() + name.slice(1);
    }

    function renderDescription(text) {
      return text.replace(/\{(\w+)\}/gi, (match, key) => {
        const lower = key.toLowerCase();
        if (allPossibleDoodles.includes(lower)) {
          return `<img src="images/${lower}.png" class="inline-doodle" alt="${formatName(lower)}">`;
        }
        if (/^\d+pt$/.test(lower) || lower === 'minus2pt') {
          const ptFile = lower === 'minus2pt' ? 'minus2pt' : lower;
          return `<img src="images/${ptFile}.png" class="inline-doodle" alt="${key}">`;
        }
        return key;
      });
    }

    let currentFilter = null;   // ← add this near the top with your other lets

    function applyGuideFilter() {
  const content = document.getElementById('guide-content');
  const rows = content.querySelectorAll('.merge-row');
  const fullBtn = document.getElementById('full-guide-btn');

  // Reset everything
  if (!currentFilter) {
    rows.forEach(row => row.style.display = 'flex');
    content.classList.remove('filtered');
    fullBtn.style.display = 'none';
    content.querySelectorAll('.guide-doodle').forEach(d => d.classList.remove('selected'));
    return;
  }

  // Filter rows
  rows.forEach(row => {
    const inputImgs = row.querySelectorAll('.inputs .guide-doodle');
    const outputImg = row.querySelector('.result .guide-doodle');

    const usesIt = Array.from(inputImgs).some(img => img.dataset.doodle === currentFilter);
    const producesIt = outputImg.dataset.doodle === currentFilter;

    row.style.display = (usesIt || producesIt) ? 'flex' : 'none';
  });

  content.classList.add('filtered');
  fullBtn.style.display = 'block';

  // Highlight every instance of the filtered doodle
  content.querySelectorAll('.guide-doodle').forEach(d => {
    d.classList.toggle('selected', d.dataset.doodle === currentFilter);
  });
}

function populateGuide() {
  const content = document.getElementById('guide-content');
  content.innerHTML = '';

  const groupBreaks = [6, 11, 15, 18, 21, 24, 27, 30, 32, 34, 36];

  doodleMerges.forEach((merge, index) => {
    const row = document.createElement('div');
    row.className = 'merge-row';

    // Inputs
    const inputsDiv = document.createElement('div');
    inputsDiv.className = 'inputs';
    merge.inputs.forEach(d => {
      const img = document.createElement('img');
      img.src = `images/${d}.png`;
      img.className = 'guide-doodle';
      img.dataset.doodle = d;
      inputsDiv.appendChild(img);
      addHoverListeners(img);  // ← Tooltip magic here
    });
    row.appendChild(inputsDiv);

    // Arrow
    const arrowContainer = document.createElement('div');
    arrowContainer.className = 'arrow-container';
    arrowContainer.innerHTML = `<div class="arrow-line"></div>`;
    row.appendChild(arrowContainer);

    // Result
    const resultDiv = document.createElement('div');
    resultDiv.className = 'result';
    const resultImg = document.createElement('img');
    resultImg.src = `images/${merge.output}.png`;
    resultImg.className = 'guide-doodle';
    resultImg.dataset.doodle = merge.output;
    resultDiv.appendChild(resultImg);
    addHoverListeners(resultImg);  // ← Tooltip magic here too
    row.appendChild(resultDiv);

    content.appendChild(row);

    // Divider
    if (groupBreaks.includes(index + 1)) {
      const divider = document.createElement('div');
      divider.className = 'group-divider';
      content.appendChild(divider);
    }
  });

  // Make every doodle clickable
  const doodleImages = content.querySelectorAll('.guide-doodle');
  doodleImages.forEach(img => {
    img.addEventListener('click', () => {
      // Clear previous selections
      content.querySelectorAll('.guide-doodle').forEach(d => d.classList.remove('selected'));
      
      // Select this one
      img.classList.add('selected');
      
      currentFilter = img.dataset.doodle;
      applyGuideFilter();
    });
  });

  // Start in full-view mode
  applyGuideFilter();
}

let hoverTimeout = null;

function addHoverListeners(element) {
  if (element.dataset.hasTooltip) return;
  element.dataset.hasTooltip = 'true';

  let mouseX, mouseY;  // Capture coords on enter

  element.addEventListener('mouseenter', (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
    clearTimeout(hoverTimeout);
    hoverTimeout = setTimeout(() => showTooltip(element, mouseX, mouseY), 500);
  });

  element.addEventListener('mouseleave', () => {
    clearTimeout(hoverTimeout);
    hideTooltip();
  });
}

function showTooltip(element, x, y) {
  const doodle = element.dataset.doodle;
  if (!doodle || !doodleDescriptions[doodle]) return;

  document.getElementById('tooltip-desc').innerHTML = renderDescription(doodleDescriptions[doodle]);

  const tooltip = document.getElementById('tooltip');
  tooltip.offsetHeight;  // Force reflow for accurate sizing

  let tooltipWidth = tooltip.offsetWidth || 260;
  let tooltipHeight = tooltip.offsetHeight || 140;

  // Position near mouse, centered horizontally, prefer above
  let left = x - (tooltipWidth / 2);
  let top = y - tooltipHeight - 16;

  // Clamp to game-container bounds
  const container = document.getElementById('game-container');
  const containerRect = container.getBoundingClientRect();
  left = Math.max(containerRect.left + 10, Math.min(left, containerRect.right - tooltipWidth - 10));
  if (top < containerRect.top + 10) {
    top = y + 16;  // Flip below if no room above
  }
  top = Math.min(top, window.innerHeight - tooltipHeight - 10);

  tooltip.style.left = `${left}px`;
  tooltip.style.top = `${top}px`;
  tooltip.classList.add('show');
}

function hideTooltip() {
  document.getElementById('tooltip').classList.remove('show');
}

    function hideTooltip() {
      document.getElementById('tooltip').classList.remove('show');
    }

    function attachMainDoodleTooltips() {
      const ids = ['doodle-l1', 'doodle-l2', 'doodle-l3', 'doodle-r1', 'doodle-r2', 'doodle-r3'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) addHoverListeners(el);
      });
    }

    function attachCellTooltips(grid) {
      grid.querySelectorAll('.doodle-cell').forEach(cell => addHoverListeners(cell));
    }

    function populateLearnGrid() {
      const grid = document.getElementById('learn-grid');
      grid.innerHTML = '';
      allPossibleDoodles.forEach(doodle => {
        const cell = document.createElement('div');
        cell.className = 'doodle-cell';
        cell.dataset.doodle = doodle;
        cell.innerHTML = `<div class="doodle-img" style="background-image: url('images/${doodle}.png')"></div>`;
        cell.addEventListener('click', () => toggleSelection(cell, grid, 'learn'));
        grid.appendChild(cell);
      });
      attachCellTooltips(grid);
    }

    function populatePortfolioGrid() {
      const grid = document.getElementById('portfolio-grid');
      grid.innerHTML = '';

      const doodlesInDeck = [];
      for (let [doodle, count] of Object.entries(deck)) {
        if (count > 0) {
          for (let i = 0; i < count; i++) {
            doodlesInDeck.push(doodle);
          }
        }
      }

      doodlesInDeck.forEach((doodle, index) => {
        const cell = document.createElement('div');
        cell.className = 'doodle-cell';
        cell.dataset.doodle = doodle;
        cell.dataset.index = index;
        cell.innerHTML = `<div class="doodle-img" style="background-image: url('images/${doodle}.png')"></div>`;
        cell.addEventListener('click', () => toggleSelection(cell, grid, 'portfolio'));
        grid.appendChild(cell);
      });
      attachCellTooltips(grid);
    }

    function toggleSelection(cell, grid, modalType) {
      const isSelected = cell.classList.contains('selected');
      const actionBtn = modalType === 'learn'
        ? document.getElementById('modal-learn-btn')
        : document.getElementById('modal-remove-btn');

      grid.querySelectorAll('.doodle-cell').forEach(c => c.classList.remove('selected'));

      if (!isSelected) {
        cell.classList.add('selected');
        actionBtn.style.display = 'block';
      } else {
        actionBtn.style.display = 'none';
      }
    }

    document.getElementById('modal-learn-btn').addEventListener('click', () => {
      const selected = document.querySelector('#learn-grid .doodle-cell.selected');
      if (selected) {
        const doodle = selected.dataset.doodle;
        deck[doodle] = (deck[doodle] || 0) + 1;

        selected.classList.add('animate-learn');

        const toast = document.getElementById('toast');
        toast.textContent = `${formatName(doodle)} added to your portfolio`;
        toast.classList.add('show');

        setTimeout(() => {
          selected.classList.remove('animate-learn');
          selected.classList.remove('selected');
          document.getElementById('modal-learn-btn').style.display = 'none';
          toast.classList.remove('show');
        }, 1200);
      }
    });

    document.getElementById('modal-remove-btn').addEventListener('click', () => {
      const selected = document.querySelector('#portfolio-grid .doodle-cell.selected');
      if (selected) {
        const doodle = selected.dataset.doodle;
        if (deck[doodle] > 0) {
          deck[doodle]--;

          selected.classList.add('animate-remove');

          setTimeout(() => {
            populatePortfolioGrid();
            document.getElementById('modal-remove-btn').style.display = 'none';
          }, 600);
        }
      }
    });

    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'flex';
      modal.offsetHeight;
      modal.classList.add('active');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('active');
      setTimeout(() => {
        modal.style.display = 'none';
        document.querySelectorAll('.doodle-cell.selected').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.action-btn').forEach(btn => btn.style.display = 'none');
      }, 400);
    }

    document.getElementById('learn-btn').addEventListener('click', () => {
      populateLearnGrid();
      openModal('learn-modal');
    });

    document.getElementById('close-learn').addEventListener('click', () => closeModal('learn-modal'));

    document.getElementById('portfolio-btn').addEventListener('click', () => {
      populatePortfolioGrid();
      openModal('portfolio-modal');
    });

    document.getElementById('close-portfolio').addEventListener('click', () => closeModal('portfolio-modal'));

    document.getElementById('guide-btn').addEventListener('click', () => {
      populateGuide();
      openModal('guide-modal');
    });

    document.getElementById('close-guide').addEventListener('click', () => closeModal('guide-modal'));

    document.getElementById('shuffle-btn').addEventListener('click', () => {
      const drawn = drawSix();
      if (!drawn) return;

      const order = ['doodle-l1', 'doodle-r1', 'doodle-l2', 'doodle-r2', 'doodle-l3', 'doodle-r3'];

      order.forEach((id, i) => {
        const div = document.getElementById(id);
        if (div && div.style.backgroundImage) {
          setTimeout(() => {
            div.style.transition = 'transform 0.175s ease-in';
            div.style.transform = 'translateY(120dvh) rotate(-720deg)';
          }, i * 50);
        }
      });

      setTimeout(() => {
        order.forEach((id, i) => {
          const div = document.getElementById(id);
          if (!div) return;

          div.style.transition = 'none';
          div.style.transform = 'translateY(100dvh) rotate(720deg)';
          div.style.backgroundImage = `url('images/${drawn[i]}.png')`;
          div.dataset.doodle = drawn[i];

          void div.offsetWidth;

          setTimeout(() => {
            div.style.transition = 'transform 0.175s ease-out';
            div.style.transform = 'translateY(0) rotate(0deg)';
          }, i * 50);
        });
      }, 325);
    });

document.getElementById('full-guide-btn').addEventListener('click', () => {
  currentFilter = null;
  applyGuideFilter();
});

    function getDeckAsArray() {
      let arr = [];
      for (let [doodle, count] of Object.entries(deck)) {
        for (let i = 0; i < count; i++) arr.push(doodle);
      }
      return arr;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function drawSix() {
      const deckArray = getDeckAsArray();
      if (deckArray.length < 6) {
        alert("You need at least 6 doodles in your deck to shuffle!");
        return null;
      }
      return shuffle([...deckArray]).slice(0, 6);
    }

    populateLearnGrid();
    attachMainDoodleTooltips();
  </script>
</body>

</html>
