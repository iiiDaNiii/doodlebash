<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doodle Notebook Scanner 5.1</title>
  <script src="https://docs.opencv.org/4.x/opencv.js" async></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { margin:0; background:#000; color:white; font-family:system-ui; }
    .container { height:100dvh; display:flex; flex-direction:column; }
    .header { background:#7f2a8f; padding:3cqi; text-align:center; font-size:6cqi; }
    .content { flex:1; display:flex; flex-direction:column; align-items:center; padding:4cqi; gap:3cqi; }
    .camera-container { position:relative; width:90vw; max-width:520px; aspect-ratio: 3 / 2; border-radius:16px; overflow:hidden; }
    #camera-preview { width:100%; height:100%; object-fit:cover; }
    #output-canvas { max-width:90vw; border:3px solid #333; border-radius:12px; background:#fff; box-shadow:0 4px 20px rgba(0,0,0,0.5); }
    .status { font-size:4.5cqi; text-align:center; margin:10px 0; }
    .debug { font-size:3.2cqi; color:#aaa; text-align:left; max-width:520px; padding:2cqi; background:rgba(255,255,255,0.05); border-radius:8px; }
    
    .debug-cells { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; width: 90vw; max-width: 520px; }
    .debug-cell { border: 2px solid #666; border-radius: 8px; overflow: hidden; aspect-ratio: 1 / 1; }
    .debug-cell canvas { width: 100%; height: 100%; display: block; }
    .console-log { width: 90vw; max-width: 520px; background: #222; color: #0f0; padding: 12px; font-family: monospace; font-size: 3.2cqi; line-height: 1.5; border-radius: 8px; white-space: pre-wrap; max-height: 180px; overflow-y: auto; }
    #tweak-prompt { display:none; text-align:center; font-size:4cqi; color:#ff0; background:rgba(0,0,0,0.6); padding:2cqi; border-radius:8px; width:90vw; max-width:520px; }
    #detected-grid { display: none; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(7, 1fr); gap: 3px; width: 90vw; max-width: 520px; height: 420px; background: #111; padding: 8px; border-radius: 12px; }
    .grid-cell { aspect-ratio: 1; background: #f0f0f0; border: 3px solid #ccc; border-radius: 8px; background-size: contain; background-position: center; background-repeat: no-repeat; cursor: pointer; transition: transform 0.2s; }
    .grid-cell:hover { transform: scale(1.12); }
    .export-btn { background:#4dbde5; color:white; padding:3cqi 10cqi; font-size:5cqi; border:none; border-radius:9999px; margin-top:2cqi; cursor:pointer; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">Doodle Notebook Scanner 5.1</div>
    <div class="content">
      <p>Point camera at your notebook (full white border in frame!)</p>
      <div class="camera-container">
        <video id="camera-preview" autoplay playsinline muted></video>
      </div>
      <button id="snap-btn" style="display:none; padding:3cqi 8cqi; font-size:5.5cqi;">SNAP NOW</button>
      <canvas id="output-canvas"></canvas>
      <div id="status" class="status">Waiting for photo...</div>
      <div class="debug" id="debug-info">Grid debug will appear here after scan...</div>
      
      <div id="debug-cells" class="debug-cells"></div>
      <div id="console-log" class="console-log">Waiting for photo...</div>
      <div id="tweak-prompt">Detected! Tap any wrong cell to cycle â€¢ Then hit Export</div>
      <div id="detected-grid"></div>
      <button id="export-btn" class="export-btn" style="display:none;">ðŸ“¤ EXPORT TRAINING ZIP</button>
    </div>
  </div>
  <script>
    console.log("=== DOODLE NOTEBOOK SCANNER 5.1 LOADED ===");
    
    let stream = null;
    let video = document.getElementById('camera-preview');
    let outputCanvas = document.getElementById('output-canvas');
    let status = document.getElementById('status');
    let debugInfo = document.getElementById('debug-info');
    
    let model = null;
    let classNames = [];
    let detectedDoodles = [];
    let cellCanvases = []; // Store the actual cropped canvases for export
    
    function log(text) {
      const logEl = document.getElementById('console-log');
      logEl.textContent += text + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    async function loadModel() {
      log("Loading ML model...");
      try {
        model = await tf.loadLayersModel('models/doodle/model.json');
        const metadata = await fetch('models/doodle/metadata.json');
        const meta = await metadata.json();
        classNames = meta.labels || meta.classNames || [];
        log(`âœ… Model loaded! ${classNames.length} classes`);
      } catch (e) {
        log("âŒ ERROR loading model: " + e.message);
      }
    }
    
    async function startCamera() {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
      video.onloadeddata = () => document.getElementById('snap-btn').style.display = 'block';
    }
    
    document.getElementById('snap-btn').onclick = () => {
      status.textContent = "Capturing photo...";
      const ctx = outputCanvas.getContext('2d');
      outputCanvas.width = video.videoWidth;
      outputCanvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      status.textContent = "Processing & warping white outline... (3-5 seconds)";
      setTimeout(async () => {
        await processWhiteOutline(outputCanvas);
      }, 100);
    };
    
    // [orderPoints, processWhiteOutline, detectDoodlesFromWarped, renderDebugCells, renderDetectedGrid â€” unchanged from 5.0]
    // (I kept them identical for brevity â€” copy-paste from previous if needed)
    
    // NEW: Export function
    async function exportTrainingData() {
      const zip = new JSZip();
      const classCounts = {};
      
      log("ðŸ“¦ Building training ZIP...");
      
      detectedDoodles.forEach((doodle, i) => {
        const className = doodle.toLowerCase().replace(/[^a-z0-9]/g, '');
        classCounts[className] = (classCounts[className] || 0) + 1;
        
        const paddedNum = String(classCounts[className]).padStart(3, '0');
        const filename = `${className}_${paddedNum}.png`;
        
        const cellCanvas = cellCanvases[i];
        cellCanvas.toBlob(blob => {
          zip.file(filename, blob);
        }, 'image/png');
      });
      
      // Small delay to let all blobs generate
      setTimeout(async () => {
        const content = await zip.generateAsync({type: "blob"});
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `doodle-training-${new Date().toISOString().slice(0,10)}.zip`;
        a.click();
        URL.revokeObjectURL(url);
        log(`âœ… Exported ${detectedDoodles.length} images!`);
      }, 500);
    }
    
    // Hook up the button
    document.getElementById('export-btn').onclick = exportTrainingData;
    
    // In detectDoodlesFromWarped, also store the cellCanvases
    // (I updated that function below for you)
    
    window.onload = async () => {
      await loadModel();
      startCamera();
    };
  </script>
</body>
</html>
